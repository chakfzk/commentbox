<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>댓글 기능</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 기본 폰트 설정 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 스크롤바 디자인 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* --- NEW: 작성자 정보 툴팁 스타일 --- */
        .comment-item {
            position: relative; /* 툴팁 위치의 기준점 */
        }
        .comment-item[data-author]:hover::after {
            content: attr(data-author); /* data-author 속성의 값을 내용으로 사용 */
            position: absolute;
            bottom: 100%; /* 요소의 위쪽에 표시 */
            left: 1rem; /* 왼쪽에서 약간 띄움 */
            margin-bottom: 5px;
            background-color: #333;
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap; /* 툴팁 내용이 줄바꿈되지 않도록 */
            z-index: 10;
            /* 부드러운 표시를 위한 전환 효과 */
            opacity: 1;
            visibility: visible;
            transition: opacity 0.2s, visibility 0.2s;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="p-4 sm:p-6 max-w-2xl mx-auto">
        <h1 class="text-2xl font-bold text-gray-900 mb-4">댓글</h1>

        <!-- 댓글 입력 폼 -->
        <form id="comment-form" class="mb-6">
            <!-- NEW: 학번, 이름 입력 필드 추가 -->
            <div class="flex flex-col sm:flex-row sm:space-x-2 mb-2">
                <div class="w-full sm:w-1/2 mb-2 sm:mb-0">
                    <label for="student-id" class="sr-only">학번</label>
                    <input type="text" id="student-id" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="학번" required>
                </div>
                <div class="w-full sm:w-1/2">
                    <label for="student-name" class="sr-only">이름</label>
                    <input type="text" id="student-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="이름" required>
                </div>
            </div>
            <div class="mb-2">
                <label for="comment-input" class="sr-only">댓글 내용</label>
                <textarea id="comment-input" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition" placeholder="댓글을 입력하세요..." required></textarea>
            </div>
            <button type="submit" id="submit-button" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200 flex items-center justify-center">
                <span id="submit-text">댓글 달기</span>
                <svg id="submit-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </form>

        <!-- 댓글 목록 -->
        <div id="comments-container" class="space-y-4">
            <div id="loading" class="text-center py-4"><p class="text-gray-500">댓글을 불러오는 중...</p></div>
            <div id="no-comments" class="text-center py-4 hidden"><p class="text-gray-500">아직 댓글이 없습니다. 첫 댓글을 남겨보세요!</p></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-comment-app';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UI 요소 ---
        const commentForm = document.getElementById('comment-form');
        const studentIdInput = document.getElementById('student-id'); // NEW
        const studentNameInput = document.getElementById('student-name'); // NEW
        const commentInput = document.getElementById('comment-input');
        const commentsContainer = document.getElementById('comments-container');
        const loadingDiv = document.getElementById('loading');
        const noCommentsDiv = document.getElementById('no-comments');
        const submitButton = document.getElementById('submit-button');
        const submitText = document.getElementById('submit-text');
        const submitSpinner = document.getElementById('submit-spinner');

        let currentUserId = null;
        
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                listenForComments();
            }
        });

        const signIn = async () => {
            try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error signing in:", error);
            }
        };

        const commentsCollectionPath = `/artifacts/${appId}/public/data/comments`;
        const commentsCol = collection(db, commentsCollectionPath);

        // --- UPDATE: 댓글 추가 함수 ---
        const addComment = async (studentId, name, text) => {
            // 입력 값 유효성 검사
            if (!studentId.trim() || !name.trim() || !text.trim()) {
                console.warn("모든 필드를 입력해주세요.");
                return;
            }
            if (!currentUserId) {
                console.error("인증 정보가 없습니다. 잠시 후 다시 시도해주세요.");
                return;
            }

            submitButton.disabled = true;
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');

            try {
                await addDoc(commentsCol, {
                    text: text,
                    studentId: studentId, // 학번 저장
                    name: name,           // 이름 저장
                    createdAt: serverTimestamp(),
                    authorId: currentUserId
                });
                // 입력 필드 초기화
                commentInput.value = '';
                studentIdInput.value = '';
                studentNameInput.value = '';
            } catch (error) {
                console.error("Error adding comment: ", error);
            } finally {
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        };

        const listenForComments = () => {
            const q = query(commentsCol);
            onSnapshot(q, (querySnapshot) => {
                loadingDiv.style.display = 'none';
                const comments = [];
                querySnapshot.forEach((doc) => {
                    comments.push({ id: doc.id, ...doc.data() });
                });
                comments.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                renderComments(comments);
            }, (error) => {
                console.error("Error listening for comments: ", error);
                loadingDiv.innerHTML = '<p class="text-red-500">댓글을 불러오는 데 실패했습니다.</p>';
            });
        };

        // --- UPDATE: 댓글 렌더링 함수 ---
        const renderComments = (comments) => {
            commentsContainer.innerHTML = ''; // 기존 댓글 비우기 (로딩/빈 메시지 포함)
            commentsContainer.appendChild(loadingDiv);
            commentsContainer.appendChild(noCommentsDiv);
            loadingDiv.style.display = 'none';

            if (comments.length === 0) {
                noCommentsDiv.classList.remove('hidden');
            } else {
                noCommentsDiv.classList.add('hidden');
                comments.forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.classList.add('comment-item', 'bg-white', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200');

                    // NEW: 마우스 오버 시 보일 작성자 정보를 data-author 속성에 저장
                    const authorInfo = `${comment.studentId || '학번없음'} ${comment.name || '이름없음'}`;
                    commentElement.setAttribute('data-author', authorInfo);

                    const date = comment.createdAt ? comment.createdAt.toDate().toLocaleString('ko-KR') : '방금 전';
                    
                    commentElement.innerHTML = `
                        <div class="flex items-start justify-between">
                            <p class="text-gray-800 whitespace-pre-wrap flex-1 pr-4">${escapeHTML(comment.text)}</p>
                            <span class="text-sm font-medium text-gray-500">익명</span>
                        </div>
                        <div class="text-right text-xs text-gray-400 mt-2">${date}</div>
                    `;
                    commentsContainer.appendChild(commentElement);
                });
            }
        };

        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, match => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[match]));
        }

        commentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            addComment(studentIdInput.value, studentNameInput.value, commentInput.value);
        });

        signIn();
    </script>
</body>
</html>
